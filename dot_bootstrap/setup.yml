
- name: Install system
  hosts: localhost
  connection: local
  become: false

  vars:
    os_type: "{{ ansible_os_family }}"

    homebrew_packages:
      - neovim
      - fzf
      - yazi
      - bat
      - eza
      - ripgrep
      - pyenv
      - virtualenv
      - gh
      - tldr
      - gcc
      - zoxide
      - wget
      - tmux
      - yt-dlp
      - repomix
      - oven-sh/bun/bun
      - pnpm
      - docker
      - docker-buildx
      - vivid
      - node
      - sketchybar
      - borders
      - jq
      - fd
      - lazygit
      - rust
      - uv
      - opencode
      - defaultbrowser

    homebrew_cask_packages:
      - arc
      - zen
      - raycast
      - cleanshot
      - 1password
      - claude
      - ghostty
      - chatgpt
      - aldente
      - visual-studio-code
      - cursor
      - discord
      - obsidian
      - font-hack-nerd-font
      - font-sketchybar-app-font
      - font-jetbrains-mono-nerd-font
      - webcatalog
      - vivid-app
      - superwhisper
      - pdf-expert

  tasks:
    - name: Update Homebrew
      community.general.homebrew:
        update_homebrew: yes

    - name: Tap Homebrew mac formulaes
      community.general.homebrew_tap:
        name:
          - FelixKratz/formulae
          - nikitabobko/tap
          - oven-sh/bun
      when: os_type == 'Darwin'
      ignore_errors: true

    - name: Install Homebrew packages
      community.general.homebrew:
        name: "{{ homebrew_packages }}"
        state: present

    - name: Clone TMP
      shell: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
      ignore_errors: true
      args:
        creates: ~/.tmux/plugins/tpm

    - name: Install aerospace (cask)
      community.general.homebrew:
        name: nikitabobko/tap/aerospace
        state: present
        install_options: ["cask"]
      when: os_type == 'Darwin'

    - name: Install Homebrew cask packages
      community.general.homebrew:
        name: "{{ item }}"
        state: present
        install_options: ["cask"]
      when: os_type == 'Darwin'
      loop: "{{ homebrew_cask_packages }}"

    - name: Set Arc as default browser
      shell: defaultbrowser browser
      when: os_type == 'Darwin'

    - name: Run nix
      shell: nix run nix-darwin -- switch --flake {{ ansible_env.HOME }}/.config/nix#default
      become: yes
      when: os_type == 'Darwin'

    - name: Set PDF Expert as default PDF app
      shell: nix run nixpkgs#duti -- -s com.readdle.PDFExpert-Mac pdf all
      when: os_type == 'Darwin'

    - name: Set IINA as default video app
      shell: |
        nix run nixpkgs#duti -- -s com.colliderli.iina mp4 all
        nix run nixpkgs#duti -- -s com.colliderli.iina mov all
        nix run nixpkgs#duti -- -s com.colliderli.iina avi all
        nix run nixpkgs#duti -- -s com.colliderli.iina mkv all
      when: os_type == 'Darwin'


